<%- include('partials/inner_header') %>

<div class="container">
    <div class="calculator-container">
        <h1 class="calculator-title"><%= title %></h1>
        
        <div class="unit-switcher">
            <button id="metricBtn" class="unit-btn active">Metric (kg, cm)</button>
            <button id="imperialBtn" class="unit-btn">Imperial (lbs, ft, in)</button>
        </div>

        <div class="calculator-grid">
            <div class="form-section">
                <form id="macroForm">
                    <div class="form-group"><label>Gender</label><div class="gender-switcher"><button type="button" id="genderMale" class="gender-btn active">Male</button><button type="button" id="genderFemale" class="gender-btn">Female</button></div></div>
                    <div class="form-group"><label for="age">Age (years)</label><div class="input-wrapper"><input type="number" id="age" min="15" max="100" placeholder="e.g., 25"></div></div>
                    <div id="metricInputs">
                        <div class="form-group"><label for="weightKg">Weight (kg)</label><div class="input-wrapper"><input type="number" id="weightKg" step="0.1" placeholder="e.g., 70"></div></div>
                        <div class="form-group"><label for="heightCm">Height (cm)</label><div class="input-wrapper"><input type="number" id="heightCm" step="1" placeholder="e.g., 175"></div></div>
                    </div>
                    <div id="imperialInputs" style="display: none;">
                        <div class="form-group"><label for="weightLbs">Weight (lbs)</label><div class="input-wrapper"><input type="number" id="weightLbs" step="0.1" placeholder="e.g., 154"></div></div>
                        <div class="form-group"><label>Height (ft, in)</label><div class="height-imperial-inputs"><div class="input-wrapper"><input type="number" id="heightFt" placeholder="e.g., 5"><span class="input-adornment">ft</span></div><div class="input-wrapper"><input type="number" id="heightIn" placeholder="e.g., 9"><span class="input-adornment">in</span></div></div></div>
                    </div>
                    <div class="form-group">
                        <label for="activityLevel">Activity Level</label>
                        <div class="input-wrapper"><select id="activityLevel"><option value="1.2">Sedentary (little or no exercise)</option><option value="1.375">Lightly active (exercise 1-3 days/week)</option><option value="1.55" selected>Moderately active (exercise 3-5 days/week)</option><option value="1.725">Very active (hard exercise 6-7 days/week)</option><option value="1.9">Extra active (very hard exercise & physical job)</option></select></div>
                    </div>
                    <div class="form-group">
                        <label for="goal">Your Goal / Diet Plan</label>
                        <div class="input-wrapper">
                            <select id="goal">
                                <option value="balanced">Balanced Diet (40/30/30)</option>
                                <option value="lowcarb">Low Carb (25/40/35)</option>
                                <option value="highprotein">High Protein (30/40/30)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="result-section" id="result-section">
                <div class="placeholder">Enter your details to calculate your daily macronutrient needs.</div>
            </div>
        </div>

        <div class="faq-section">
            <div class="accordion-item"><button class="accordion-header"><span>What are Macronutrients?</span><span class="icon">+</span></button><div class="accordion-content"><p>Macronutrients, or "macros," are the three main nutrients your body needs in large amounts: Protein, Carbohydrates, and Fat. Each provides energy (calories) and serves unique functions in the body.</p></div></div>
            <div class="accordion-item"><button class="accordion-header"><span>Understanding the Ratios (C/P/F)</span><span class="icon">+</span></button><div class="accordion-content"><p>The ratios (e.g., 40/30/30) represent the percentage of your total daily calories that should come from Carbohydrates, Protein, and Fat, respectively. Different diet plans recommend different ratios to achieve specific health or fitness goals.</p></div></div>
            <div class="accordion-item"><button class="accordion-header"><span>Important Medical Disclaimer</span><span class="icon">+</span></button><div class="accordion-content"><p>This calculator provides an estimate for informational purposes. Individual needs can vary greatly. For a personalized nutrition plan, please consult with a registered dietitian or healthcare professional.</p></div></div>
        </div>
    </div>
</div>

<script>
    let currentUnit = 'metric', currentGender = 'male';
    const allInputs = document.querySelectorAll('input, select');
    const resultDiv = document.getElementById('result-section');
    const metricBtn = document.getElementById('metricBtn');
    const imperialBtn = document.getElementById('imperialBtn');
    const genderMaleBtn = document.getElementById('genderMale');
    const genderFemaleBtn = document.getElementById('genderFemale');
    const metricInputsDiv = document.getElementById('metricInputs');
    const imperialInputsDiv = document.getElementById('imperialInputs');

    // --- UNIT SWITCHER LOGIC ---
    function switchUnit(unit) {
        currentUnit = unit;
        metricBtn.classList.toggle('active', unit === 'metric');
        imperialBtn.classList.toggle('active', unit === 'imperial');
        metricInputsDiv.style.display = unit === 'metric' ? 'block' : 'none';
        imperialInputsDiv.style.display = unit === 'imperial' ? 'block' : 'none';
        
        // Reset all inputs on switch, including dropdowns
        document.querySelectorAll('input').forEach(i => i.value = '');
        document.querySelector("#activityLevel").value = "1.55";
        document.querySelector("#goal").value = "balanced";
        
        resultDiv.innerHTML = `<div class="placeholder">Enter your details to calculate.</div>`;
    }
    metricBtn.addEventListener('click', () => switchUnit('metric'));
    imperialBtn.addEventListener('click', () => switchUnit('imperial'));

    // --- GENDER SWITCHER LOGIC ---
    function switchGender(gender) {
        currentGender = gender;
        genderMaleBtn.classList.toggle('active', gender === 'male');
        genderFemaleBtn.classList.toggle('active', gender === 'female');
        calculateMacros();
    }
    genderMaleBtn.addEventListener('click', () => switchGender('male'));
    genderFemaleBtn.addEventListener('click', () => switchGender('female'));

    // --- ATTACH EVENT LISTENER TO ALL INPUTS ---
    allInputs.forEach(input => input.addEventListener('input', calculateMacros));

    // --- MAIN CALCULATION FUNCTION ---
    function calculateMacros() {
        let weightInKg, heightInCm;
        const age = parseFloat(document.getElementById('age').value);
        const activityMultiplier = parseFloat(document.getElementById('activityLevel').value);
        const goal = document.getElementById('goal').value;

        if (currentUnit === 'metric') {
            weightInKg = parseFloat(document.getElementById('weightKg').value);
            heightInCm = parseFloat(document.getElementById('heightCm').value);
        } else {
            const lbs = parseFloat(document.getElementById('weightLbs').value);
            const ft = parseFloat(document.getElementById('heightFt').value);
            const inches = parseFloat(document.getElementById('heightIn').value) || 0;
            if (!isNaN(lbs)) weightInKg = lbs * 0.453592;
            if (!isNaN(ft)) heightInCm = (ft * 12 + inches) * 2.54;
        }

        if (isNaN(weightInKg) || isNaN(heightInCm) || isNaN(age) || age < 15) {
            resultDiv.innerHTML = `<div class="placeholder">Please enter all valid details.</div>`;
            return;
        }

        const bmr = (currentGender === 'male') ? (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) + 5 : (10 * weightInKg) + (6.25 * heightInCm) - (5 * age) - 161;
        const tdee = Math.round(bmr * activityMultiplier);

        const ratios = {
            balanced: { carbs: 0.40, protein: 0.30, fat: 0.30 },
            lowcarb: { carbs: 0.25, protein: 0.40, fat: 0.35 },
            highprotein: { carbs: 0.30, protein: 0.40, fat: 0.30 }
        };

        const chosenRatios = ratios[goal];
        const proteinCalories = tdee * chosenRatios.protein;
        const carbsCalories = tdee * chosenRatios.carbs;
        const fatCalories = tdee * chosenRatios.fat;
        
        const proteinGrams = Math.round(proteinCalories / 4);
        const carbsGrams = Math.round(carbsCalories / 4);
        const fatGrams = Math.round(fatCalories / 9);

        resultDiv.innerHTML = `
            <div class="result-display-new">
                <p class="result-main-text-large">Your Maintenance Calories: <strong>${tdee.toLocaleString()}</strong></p>
                <p class="result-main-unit">kcal/day</p>
                <hr class="result-divider" />
                <p class="result-sub-text">Based on your selected goal, here is your daily macronutrient breakdown:</p>
            </div>
            <div class="macro-list-container">
                <div class="macro-list-item">
                    <div class="macro-list-grams">${proteinGrams}g</div>
                    <div class="macro-list-label">Protein</div>
                    <div class="macro-list-calories">${Math.round(proteinCalories).toLocaleString()} kcal</div>
                </div>
                <div class="macro-list-item">
                    <div class="macro-list-grams">${carbsGrams}g</div>
                    <div class="macro-list-label">Carbs</div>
                    <div class="macro-list-calories">${Math.round(carbsCalories).toLocaleString()} kcal</div>
                </div>
                <div class="macro-list-item">
                    <div class="macro-list-grams">${fatGrams}g</div>
                    <div class="macro-list-label">Fat</div>
                    <div class="macro-list-calories">${Math.round(fatCalories).toLocaleString()} kcal</div>
                </div>
            </div>
        `;
    }

    // --- ACCORDION LOGIC ---
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const accordionItem = header.parentElement;
            accordionItem.classList.toggle('active');
            const content = header.nextElementSibling;
            content.style.maxHeight = accordionItem.classList.contains('active') ? content.scrollHeight + 'px' : '0px';
        });
    });
</script>

<%- include('partials/inner_footer') %>